#!/bin/bash

if [[ ! $1 ]];then
    echo "Usage: vbc <env> <command>"
    echo "Command list:"

    # TODO: 这里猜了一下用户的目录
    master_home=/home/$VAGBOOK_MASTER

    # 公共目录处理
    if [[ -f $master_home/vagbook/${VAGBOOK_MASTER}/whitelist.txt ]];then
        cat $master_home/vagbook/${VAGBOOK_MASTER}/whitelist.txt
        echo ""
    else
        ymllist=($(find $master_home/vagbook/ -maxdepth 1 -name "*.yml"))
        for i in "${ymllist[@]}"; do
            tmp=${i%%.yml*}
            echo ${tmp##*/}
        done
    fi

    # 私有目录处理
    if [[ -d $master_home/vagbook/${VAGBOOK_MASTER} ]];then
        ymllist=($(find $master_home/vagbook/${VAGBOOK_MASTER}/ -maxdepth 1 -name "*.yml"))
        for i in "${ymllist[@]}"; do
            tmp=${i%%.yml*}
            echo @${tmp##*/}
        done
    fi

    exit
fi

if [[ ! $2 ]];then
    echo "Usage: vbc <env> <command>"
    exit
fi

if [[ ${2:0:1} == "@" ]];then
    book=./vagbook/${VAGBOOK_MASTER}/${2:1}.yml
else
    book=./vagbook/${2}.yml
fi

hosts=hosts.${1}

# debug
echo "ansible-playbook -i $hosts $book"

sudo -i -u ${VAGBOOK_MASTER} ansible-playbook -i $hosts $book
